const express = require('express')
const path = require('path');
const tiktok = require('./tiktok');
const message = require('./message');
const websocket = require('express-ws');

const app = express()
websocket(app);
const port = 3000

app.use('/images', express.static(__dirname + '/public/images'));

app.get('/',  (req, res) => {
  res.sendFile(path.join(__dirname, 'views/index.html'));
});

app.get('/bot/login', async (req, res) => {
	await tiktok.presentLogin();
});

app.get('/bot/start', async (req, res) => {
	const handles = req.query.handles.split(":")
	handles.pop();
	message.send('Starting bot for ' + handles.length + ' accounts...');
	for (var i = handles.length - 1; i >= 0; i--) {
		message.send('Getting videos for ' + handles[i] + '...');
		const urls = await tiktok.getVideoUrls(handles[i]);
		message.send('Found ' + urls.length + ' videos.');
		for (var i = urls.length - 1; i >= 0; i--) {
			message.send('Liking comments at ' + urls[i] + '...');
			await tiktok.likeComments(urls[i]);
			message.send('Finished liking comments.');
		}
	}
});

app.ws('/log', function(ws, req) {
	message.setup(ws);
});

app.listen(port, () => {
	console.log(`Example app listening on port ${port}`)
});
